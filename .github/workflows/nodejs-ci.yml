name: Node.js CI (Server tests)

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  server-tests:
    name: Server tests (matrix)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node-version: ['16', '18', '20']
    env:
      NODE_ENV: test
      # Store mongod binary under the workspace to allow caching between runs
      MONGOMS_DOWNLOAD_DIR: ${{ github.workspace }}/.cache/mongodb
      # Give mongodb-memory-server more time to start in CI (ms)
      MONGOMS_STARTUP_TIMEOUT_MS: '60000'
      # Short-lived test secrets used by the test suites
      JWT_SECRET: test-secret
      ENCRYPTION_KEY: dev_key_change_in_tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Ensure cache folder exists
        run: mkdir -p ./.cache/mongodb

      - name: Cache MongoDB binary
        uses: actions/cache@v4
        with:
          path: ./.cache/mongodb
          key: ${{ runner.os }}-mongo-binaries-${{ matrix.node-version }}-${{ hashFiles('server/package-lock.json') }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Cache npm modules (server)
        uses: actions/cache@v4
        with:
          path: server/node_modules
          key: ${{ runner.os }}-server-node-modules-${{ matrix.node-version }}-${{ hashFiles('server/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-server-node-modules-${{ matrix.node-version }}-
          restore-keys: |
            ${{ runner.os }}-server-node-modules-

      - name: Install server dependencies
        working-directory: server
        run: npm ci

      - name: Run server tests
        working-directory: server
        run: npm test
